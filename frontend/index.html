<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interview Assistant // Parakeet Clone</title>
  <style>
    :root {
      --bg-color: #0d0d0d;
      --card-bg: #1c1c1e;
      --accent-color: #007aff;
      --accent-hover: #005bb5;
      --text-main: #ffffff;
      --text-muted: #86868b;
      --success-color: #30d158;
      --transcript-color: #a1a1aa;
      --answer-color: #e2e8f0;
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: var(--font-family);
      margin: 0;
      padding: 20px;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      overflow-y: hidden; /* Prevent body scroll, handle inside cards */
    }

    .container {
      width: 100%;
      max-width: 600px; /* Optimal reading width */
      height: 95vh;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* HEADER */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 5px;
    }

    h1 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-muted);
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--success-color);
      background: rgba(48, 209, 88, 0.1);
      padding: 4px 10px;
      border-radius: 20px;
    }

    .pulse {
      width: 8px;
      height: 8px;
      background-color: var(--success-color);
      border-radius: 50%;
      box-shadow: 0 0 0 rgba(48, 209, 88, 0.7);
      animation: pulse-animation 2s infinite;
    }

    @keyframes pulse-animation {
      0% { box-shadow: 0 0 0 0 rgba(48, 209, 88, 0.7); }
      70% { box-shadow: 0 0 0 6px rgba(48, 209, 88, 0); }
      100% { box-shadow: 0 0 0 0 rgba(48, 209, 88, 0); }
    }

    /* CARDS */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      border: 1px solid #333;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    .label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 8px;
      font-weight: 700;
    }

    /* TRANSCRIPT SECTION */
    .transcript-card {
      flex: 1; /* Takes minimal space necessary */
      min-height: 100px;
      max-height: 30%;
      position: relative;
    }

    .transcript-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
    }

    .mini-btn {
      background: #2a2a2d;
      color: var(--text-muted);
      border: 1px solid #333;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .mini-btn:hover {
      background: #333;
      color: var(--text-main);
      border-color: #444;
    }

    #sttBox {
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      line-height: 1.4;
      color: var(--transcript-color);
      overflow-y: auto;
      height: 100%;
      border-left: 2px solid #333;
      padding-left: 10px;
    }

    /* ANSWER SECTION - THE HERO */
    .answer-card {
      flex: 2; /* Takes up more space */
      position: relative;
    }

    #answerBox {
      font-size: 16px;
      line-height: 1.6;
      color: var(--answer-color);
      overflow-y: auto;
      height: 100%;
      white-space: pre-wrap;
    }

    /* BUTTON */
    .btn-container {
      display: flex;
      justify-content: center;
    }

    button {
      width: 100%;
      padding: 14px;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }

    button:hover {
      background-color: var(--accent-hover);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(1px);
    }

    /* SCROLLBAR STYLING */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

  </style>
</head>

<body>

  <div class="container">
    <header>
      <h1>Interview AI</h1>
      <div class="status-badge">
        <div class="pulse"></div>
        <span>SYSTEM READY</span>
      </div>
    </header>

    <div class="card transcript-card">
      <div class="label">Listening To Interviewer...</div>
      <div class="transcript-actions">
        <button id="clearSttBtn" class="mini-btn">Clear</button>
      </div>
      <div id="sttBox" contenteditable="true">Waiting for speech...</div>
    </div>

    <div class="btn-container">
      <button id="answerBtn">Generate Answer</button>
    </div>

    <div class="card answer-card">
      <div class="label">Suggested Response</div>
      <div id="answerBox"></div>
    </div>
  </div>

<script>
  // EXACT LOGIC AS PROVIDED - NO CHANGES
  const sttBox = document.getElementById("sttBox");
  const answerBox = document.getElementById("answerBox");
  const answerBtn = document.getElementById("answerBtn");
  const clearSttBtn = document.getElementById("clearSttBtn");

  let lastTranscript = "";
  let wsSTT = null;
  let wsASK = null;

  const API_BASE = "http://localhost:8000";

  async function initSession() {
    // Wrapped in a timeout to allow UI to render first before blocking prompts appear
    setTimeout(async () => {
        // const resume = prompt("Paste resume summary:", "Flutter and MERN stack developer skilled in building high-performance mobile and web apps. Delivered projectslike Stockship and KO-Captain that increasedshipment tracking accuracy by 35% and improved data processing speed by 40%. Expert in Flutter UI/UX, REST API integration, and state management with Provider and GetX. Proven ability to deliver production-ready solutions in fast-paced, team-driven environments.");
        // const jd = prompt("Paste JD summary:", "We are looking for enthusiastic Flutter Trainees who are eager to learn and build their career in mobile app development. You will work closely with our development team, gain hands-on experience, and get exposure to real-time projects.");
        // const company = prompt("Company:", "Hacker Kernel");
        // const role = prompt("Role:", "Flutter Trainee");
        // const extra = prompt("Extra instructions (optional):", "");

        const resume = "Flutter and MERN stack developer skilled in building high-performance mobile and web apps. Delivered projectslike Stockship and KO-Captain that increasedshipment tracking accuracy by 35% and improved data processing speed by 40%. Expert in Flutter UI/UX, REST API integration, and state management with Provider and GetX. Proven ability to deliver production-ready solutions in fast-paced, team-driven environments.";
        const jd = "We are looking for enthusiastic Flutter Trainees who are eager to learn and build their career in mobile app development. You will work closely with our development team, gain hands-on experience, and get exposure to real-time projects.";
        const company = "Hacker Kernel";
        const role = "Flutter Trainee";
        const extra = "";

        const resp = await fetch(`${API_BASE}/session/init`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            resume_text: resume || "",
            jd_text: jd || "",
            company: company || "",
            role: role || "",
            extra_instructions: extra || ""
          })
        });

        const data = await resp.json();
        console.log("Session init:", data);
        if (data.status !== "session_initialized") {
          alert("Session initialization failed.");
        }
    }, 500);
  }

  // Run at startup
  initSession();

  // -------------------------------
  // CONNECT TO STT WEBSOCKET
  // -------------------------------
  function connectSTT() {
    wsSTT = new WebSocket("ws://localhost:8000/ws/stt");

    wsSTT.onopen = () => {
      console.log("STT WebSocket connected");
      // keepalive message every 30 sec
      setInterval(() => wsSTT.send("ping"), 30000);
    };

    wsSTT.onmessage = (evt) => {
      const text = evt.data.trim();
      if (!text) return;

      // Accumulate STT fragments while guarding against duplicate/superset repeats
      if (!lastTranscript) {
        lastTranscript = text;
      } else if (text.startsWith(lastTranscript)) {
        // New chunk contains the previous buffer (superset) → replace
        lastTranscript = text;
      } else if (lastTranscript.endsWith(text) || lastTranscript === text) {
        // Exact or suffix repeat → ignore
      } else {
        lastTranscript = `${lastTranscript} ${text}`.trim();
      }
      sttBox.textContent = lastTranscript;
    };

    wsSTT.onclose = () => {
      console.log("STT WS closed, reconnecting...");
      setTimeout(connectSTT, 2000);
    };
  }

  connectSTT();

  // Allow manual clearing/editing of transcript
  clearSttBtn.onclick = () => {
    lastTranscript = "";
    sttBox.textContent = "";
  };


  // -------------------------------
  // SEND QUESTION -> AI ANSWER STREAM
  // -------------------------------
  answerBtn.onclick = () => {
    // Always read the latest edited transcript
    lastTranscript = sttBox.textContent.trim();

    if (!lastTranscript) {
      alert("No transcript available yet.");
      return;
    }

    answerBox.textContent = ""; // clear previous answer

    // close existing connection if open
    if (wsASK) wsASK.close();

    wsASK = new WebSocket("ws://localhost:8000/ws/ask");

    wsASK.onopen = () => {
      wsASK.send(JSON.stringify({ question: lastTranscript }));
    };

    wsASK.onmessage = (evt) => {
      const msg = evt.data;
      if (msg === "[END]") {
        return;
      }
      answerBox.textContent += msg;
    };

    wsASK.onerror = (err) => console.error("Ask error:", err);
  };
</script>

</body>
</html>